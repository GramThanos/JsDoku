/*
 * Jsdoku View v1.0.0-beta
 */

var JsdokuView=function(){function d(a,b,c){this.init(a.grid,a.solved.grid,b);this.build();this.gameEndHandler=function(){};c=c||document.body;c.appendChild(this.html.wrapper)}function h(a,b){this.init(a);this.build();b=b||document.body;b.appendChild(this.html.wrapper)}d.version="v1.0.0-beta";d.prototype.init=function(a,b,c){this.N=Math.floor(Math.sqrt(a.length));this.N_Square=this.N*this.N;this.keys=null;if(c)this.keys=c.slice(0);else for(this.keys=[],c=1;c<=this.N_Square;c++)this.keys.push(c);this.empty=
0;this.grid=[];for(c=0;c<this.N_Square;c++)this.grid.push(a[c].slice(0));this.solved=[];for(c=0;c<this.N_Square;c++)this.solved.push(b[c].slice(0));for(c=0;c<this.N_Square;c++)for(a=0;a<this.N_Square;a++)this.grid[c][a]&&(this.grid[c][a]=this.keys[this.grid[c][a]-1]);this._onclick_handlers=[]};d.prototype.build=function(){this.html={};this.html.wrapper=document.createElement("table");this.html.wrapper.className="jsdoku n"+this.N;this.html.cells=[];var a,b;for(a=0;a<this.N_Square;a++){this.html.cells.push([]);
var c=document.createElement("tr");this.html.wrapper.appendChild(c);for(b=0;b<this.N_Square;b++){var g=this.buildCell(a,b);g.wrapper.className="cell-"+(b+1)+"-"+(a+1);this.grid[a][b]?(g.freeze=!0,g.value.innerHTML=this.grid[a][b],g.wrapper.classList.add("fixed")):this.empty++;this.html.cells[a].push(g);c.appendChild(g.wrapper)}}};d.prototype.buildCell=function(a,b){var c=document.createElement("td"),g=document.createElement("span");c.appendChild(g);var d=[],k=document.createElement("table");k.className=
"notes";c.appendChild(k);var l,e;for(l=0;l<this.N;l++){d.push([]);var f=document.createElement("tr");k.appendChild(f);for(e=0;e<this.N;e++){var h=document.createElement("td");f.appendChild(h);d.push(h)}}var m=this;c.addEventListener("click",function(){m.handleCellClick(a,b)},!1);return{freeze:!1,value:g,notes:d,wrapper:c}};d.prototype.handleCellClick=function(a,b,c){var g=[a-a%this.N,a-a%this.N+this.N-1],d=[b-b%this.N,b-b%this.N+this.N-1],k=this.grid[a][b],h=0,e,f;for(e=this.N_Square-1;0<=e;e--)for(f=
this.N_Square-1;0<=f;f--)a==e||b==f||g[0]<=e&&g[1]>=e&&d[0]<=f&&d[1]>=f?this.html.cells[e][f].wrapper.classList.add("hilight"):this.html.cells[e][f].wrapper.classList.remove("hilight"),0<k&&(k==this.grid[e][f]?(this.html.cells[e][f].wrapper.classList.add("match"),h++):this.html.cells[e][f].wrapper.classList.remove("match")),this.html.cells[e][f].wrapper.classList.remove("selected");this.html.cells[a][b].wrapper.classList.add("selected");if(!c)for(c=0;c<this._onclick_handlers.length;c++)setTimeout(function(c){return function(){c(a,
b,k,h)}}(this._onclick_handlers[c]),0)};d.prototype.onClick=function(a){this._onclick_handlers.push(a)};d.prototype.set=function(a,b,c){if(this.html.cells[a][b].freeze)return!1;if(!c)return this.grid[a][b]==this.solved[a][b]&&this.empty++,this.html.cells[a][b].value.innerHTML="",this.grid[a][b]=0,this.handleCellClick(a,b,!0),!1;var g=this.keys.indexOf(c)+1;this.html.cells[a][b].value.innerHTML=c;this.grid[a][b]=g;this.grid[a][b]==this.solved[a][b]&&this.empty--;this.handleCellClick(a,b,!0);if(0==
this.empty){for(a=this.N_Square-1;0<=a;a--)for(b=this.N_Square-1;0<=b;b--)this.html.cells[a][b].freeze=!0;var d=this;setTimeout(function(){d.gameEndHandler()},10)}return!0};d.prototype.onGameEnd=function(a){this.gameEndHandler=a};h.prototype.init=function(a){this.N=Math.floor(Math.sqrt(a.keys.length));this.N_Square=a.keys.length;this.keys=a.keys.slice(0);this.view=a;this.selected={x:0,y:0};var b=this;this.view.onClick(function(a,d,h,k){b.handleCellClick(a,d,h,k)})};h.prototype.build=function(){var a=
this;this.html={};this.html.wrapper=document.createElement("div");this.html.wrapper.className="jsdoku-keys";this.html.keys=[];for(var b,c=0;c<this.keys.length;c++)b=document.createElement("div"),b.className="key disabled",b.innerHTML=this.keys[c],this.html.keys.push(b),this.html.wrapper.appendChild(b),b.addEventListener("click",function(b){return function(){a.handleKeyClick(b)}}(this.keys[c]),!1);b=document.createElement("div");b.className="key disabled";b.innerHTML="&times;";this.html.keys.push(b);
this.html.wrapper.appendChild(b);b.addEventListener("click",function(){a.handleKeyClick(0)},!1)};h.prototype.handleKeyClick=function(a){this.view.set(this.selected.y,this.selected.x,a)};h.prototype.handleCellClick=function(a,b,c,d){this.selected.y=a;this.selected.x=b;for(a=0;a<this.html.keys.length-1;a++)this.html.keys[a].className="key available";this.html.keys[this.html.keys.length-1].className="key available"};d.Keys=h;return d}();
